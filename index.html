<!DOCTYPE html>
<html>
<head>
  <title>4 images 1 mot - Codiscovery - Kryptonik</title>
  <style>
    body {
      background: #23293E;
      color: #FFF;
      font-family: Arial, Helvetica, sans-serif;
      margin: 0 auto;
    }
    h1 {
      text-align: center;
    }
    img {
      width: 49%;
      display: inline-block;
    }
    li {
      display: inline-block;
      list-style: none;
      padding: 5px 8px;
      cursor: pointer;
      background: #FFF;
      margin: 2px;
      color: #000;
    }
    .mystery {
      text-align: center;
    }
    .mystery div {
      display: inline-block;
      width: 10px;
      height: 20px;
      border-bottom: 1px solid #FFF;
      padding: 5px;
      margin: 2px;
    }
  </style>
</head>
<body>
  <h1>Level -</h1>
  <div class="imgs">
    <img />
    <img />
    <img />
    <img />
  </div>
  <div class="mystery"></div>
  <ul class="letters">
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
  </ul>
  <script type="text/javascript">
    // INITIALISATION
    let answer = '';
    let selectedWord = '';
    let currentLevel = 1;
    let shuffledLetters = [];
    let maxLettersIndex = 0;
    let maxLevel = 0;
    const mysteryEl = document.getElementsByClassName('mystery')[0];

    // MAIN
    const buildLevel = async (isReshuffled = true) => {
      // RESET
      answer = '';

      // TITLE
      const titleEl = document.getElementsByTagName('h1')[0];
      titleEl.innerHTML = `Level ${currentLevel}`;

      // API
      const apiResponse = await fetch(`http://labs.kryptonik.net/four_images_one_word/api/level/${currentLevel}`);
      const wordObj = await apiResponse.json();
      console.log('wordObj', wordObj);
      maxLevel = wordObj.maxLevel;

      // IMAGES
      // const img1El = document.getElementsByTagName('img')[0];
      // img1El.src = wordObj.imgs[0];
      // const img2El = document.getElementsByTagName('img')[1];
      // img2El.src = wordObj.imgs[1];
      // const img3El = document.getElementsByTagName('img')[2];
      // img3El.src = wordObj.imgs[2];
      // const img4El = document.getElementsByTagName('img')[3];
      // img4El.src = wordObj.imgs[3];

      wordObj.imgs.forEach((src, index) => {
        const imgEl = document.getElementsByTagName('img')[index];
        imgEl.src = src;
      });

      // LETTERS - INITIALISATION
      const letters = wordObj.word.split('');
      selectedWord = wordObj.word;

      maxLettersIndex = letters.length - 1;

      // LETTERS - REMOVE PREVIOUS
      let rmChild = mysteryEl.firstChild;
      while (rmChild) {
        mysteryEl.removeChild(rmChild);
        rmChild = mysteryEl.firstChild;
      }

      // LETTERS - MYSTERY LENGTH
      letters.forEach(() => {
        const letterEl = document.createElement('div');
        mysteryEl.appendChild(letterEl);
      });

      // LETTERS - SHUFFLE
      while (letters.length < 12) {
        letters.push(getRandomLetter());
      }
      console.log('letters 12', letters);

      if (isReshuffled === true) {
        shuffledLetters = letters;
        shuffle(shuffledLetters);
      }

      shuffledLetters.forEach((letter, index) => {
        const liEl = document.getElementsByTagName('li')[index];
        liEl.style.opacity = 1;
        liEl.textContent = letter;
      });
    };
    // EVENT LISTENERS
    const attachClickLetter = (e) => {
      const liEl = e.target;
      const letter = liEl.textContent;

      if (liEl.style.opacity === '0') {
        return;
      }

      liEl.style.opacity = 0;

      let isValueEntered = false;
      mysteryEl.childNodes.forEach((divEl, index) => {
        if (isValueEntered === false) {
          if (divEl.textContent === '') {
            divEl.textContent = letter;
            isValueEntered = true;
            answer += letter;
            if (index === maxLettersIndex) {
              checkAnswer();
            }
          }
        }
      });
    };

    document.getElementsByTagName('ul')[0].childNodes.forEach((el) => {
      el.addEventListener('click', attachClickLetter);
    });

    // ANSWER
    const checkAnswer = () => {
      console.log('answer:', answer);
      console.log('selectedWord:', selectedWord);
      if (answer === selectedWord) {
        currentLevel++;
        if (currentLevel > maxLevel) {
          alert('THE END');
        } else {
          alert('SUCCESS');
          buildLevel();
        }
      } else {
        alert('WRONG');
        buildLevel(false);
      }
    };

    // FUNCTIONS
    const getRandomLetter = () => {
      const num = getRandomInt(1, 26);
      return String.fromCharCode(num + 64);
    };
    const getRandomInt = (min, max) => {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    };
    const shuffle = (a) => {
      for (let i = a.length; i; i--) {
        let j = Math.floor(Math.random() * i);
        [a[i - 1], a[j]] = [a[j], a[i - 1]];
      }
    };

    // STARTER
    buildLevel();
  </script>
</body>
</html>